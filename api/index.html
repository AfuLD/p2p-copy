
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../layout/">
      
      
        <link rel="next" href="../examples/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.20">
    
    
      
        <title>API - p2p-copy</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.e53b48f4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#api-reference" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="p2p-copy" class="md-header__button md-logo" aria-label="p2p-copy" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            p2p-copy
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              API
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/AfuLD/p2p-copy" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="p2p-copy" class="md-nav__button md-logo" aria-label="p2p-copy" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    p2p-copy
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/AfuLD/p2p-copy" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../usage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Usage
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../layout/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Module Layout
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    API
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    API
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#p2p_copy_server" class="md-nav__link">
    <span class="md-ellipsis">
      p2p_copy_server
    </span>
  </a>
  
    <nav class="md-nav" aria-label="p2p_copy_server">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#p2p_copy_server.run_relay" class="md-nav__link">
    <span class="md-ellipsis">
      run_relay
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#p2p_copy.api" class="md-nav__link">
    <span class="md-ellipsis">
      api
    </span>
  </a>
  
    <nav class="md-nav" aria-label="api">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#p2p_copy.api.send" class="md-nav__link">
    <span class="md-ellipsis">
      send
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.api.receive" class="md-nav__link">
    <span class="md-ellipsis">
      receive
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#p2p_copy.security" class="md-nav__link">
    <span class="md-ellipsis">
      security
    </span>
  </a>
  
    <nav class="md-nav" aria-label="security">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#p2p_copy.security.SecurityHandler" class="md-nav__link">
    <span class="md-ellipsis">
      SecurityHandler
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SecurityHandler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#p2p_copy.security.SecurityHandler.encrypt_chunk" class="md-nav__link">
    <span class="md-ellipsis">
      encrypt_chunk
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.security.SecurityHandler.decrypt_chunk" class="md-nav__link">
    <span class="md-ellipsis">
      decrypt_chunk
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.security.SecurityHandler.build_encrypted_manifest" class="md-nav__link">
    <span class="md-ellipsis">
      build_encrypted_manifest
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.security.ChainedChecksum" class="md-nav__link">
    <span class="md-ellipsis">
      ChainedChecksum
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ChainedChecksum">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#p2p_copy.security.ChainedChecksum.next_hash" class="md-nav__link">
    <span class="md-ellipsis">
      next_hash
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.security.import_optional_security_libs" class="md-nav__link">
    <span class="md-ellipsis">
      import_optional_security_libs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#p2p_copy.compressor" class="md-nav__link">
    <span class="md-ellipsis">
      compressor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compressor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#p2p_copy.compressor.CompressMode" class="md-nav__link">
    <span class="md-ellipsis">
      CompressMode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.compressor.Compressor" class="md-nav__link">
    <span class="md-ellipsis">
      Compressor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Compressor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#p2p_copy.compressor.Compressor.determine_compression" class="md-nav__link">
    <span class="md-ellipsis">
      determine_compression
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.compressor.Compressor.compress" class="md-nav__link">
    <span class="md-ellipsis">
      compress
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.compressor.Compressor.decompress" class="md-nav__link">
    <span class="md-ellipsis">
      decompress
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.compressor.Compressor.set_decompression" class="md-nav__link">
    <span class="md-ellipsis">
      set_decompression
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#p2p_copy.protocol" class="md-nav__link">
    <span class="md-ellipsis">
      protocol
    </span>
  </a>
  
    <nav class="md-nav" aria-label="protocol">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#p2p_copy.protocol.Hello" class="md-nav__link">
    <span class="md-ellipsis">
      Hello
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.protocol.ManifestEntry" class="md-nav__link">
    <span class="md-ellipsis">
      ManifestEntry
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.protocol.Manifest" class="md-nav__link">
    <span class="md-ellipsis">
      Manifest
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.protocol.EncryptedManifest" class="md-nav__link">
    <span class="md-ellipsis">
      EncryptedManifest
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.protocol.ReceiverManifestEntry" class="md-nav__link">
    <span class="md-ellipsis">
      ReceiverManifestEntry
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.protocol.ReceiverManifest" class="md-nav__link">
    <span class="md-ellipsis">
      ReceiverManifest
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.protocol.EncryptedReceiverManifest" class="md-nav__link">
    <span class="md-ellipsis">
      EncryptedReceiverManifest
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.protocol.dumps" class="md-nav__link">
    <span class="md-ellipsis">
      dumps
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.protocol.loads" class="md-nav__link">
    <span class="md-ellipsis">
      loads
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.protocol.file_begin" class="md-nav__link">
    <span class="md-ellipsis">
      file_begin
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.protocol.encrypted_file_begin" class="md-nav__link">
    <span class="md-ellipsis">
      encrypted_file_begin
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.protocol.pack_chunk" class="md-nav__link">
    <span class="md-ellipsis">
      pack_chunk
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.protocol.unpack_chunk" class="md-nav__link">
    <span class="md-ellipsis">
      unpack_chunk
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#p2p_copy.io_utils" class="md-nav__link">
    <span class="md-ellipsis">
      io_utils
    </span>
  </a>
  
    <nav class="md-nav" aria-label="io_utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#p2p_copy.io_utils.read_in_chunks" class="md-nav__link">
    <span class="md-ellipsis">
      read_in_chunks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.io_utils.compute_chain_up_to" class="md-nav__link">
    <span class="md-ellipsis">
      compute_chain_up_to
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.io_utils.iter_manifest_entries" class="md-nav__link">
    <span class="md-ellipsis">
      iter_manifest_entries
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.io_utils.ensure_dir" class="md-nav__link">
    <span class="md-ellipsis">
      ensure_dir
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    APIExamples
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../relay/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Relay Setup
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../features/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Features
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../security/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Security
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../troubleshooting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Troubleshooting
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#p2p_copy_server" class="md-nav__link">
    <span class="md-ellipsis">
      p2p_copy_server
    </span>
  </a>
  
    <nav class="md-nav" aria-label="p2p_copy_server">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#p2p_copy_server.run_relay" class="md-nav__link">
    <span class="md-ellipsis">
      run_relay
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#p2p_copy.api" class="md-nav__link">
    <span class="md-ellipsis">
      api
    </span>
  </a>
  
    <nav class="md-nav" aria-label="api">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#p2p_copy.api.send" class="md-nav__link">
    <span class="md-ellipsis">
      send
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.api.receive" class="md-nav__link">
    <span class="md-ellipsis">
      receive
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#p2p_copy.security" class="md-nav__link">
    <span class="md-ellipsis">
      security
    </span>
  </a>
  
    <nav class="md-nav" aria-label="security">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#p2p_copy.security.SecurityHandler" class="md-nav__link">
    <span class="md-ellipsis">
      SecurityHandler
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SecurityHandler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#p2p_copy.security.SecurityHandler.encrypt_chunk" class="md-nav__link">
    <span class="md-ellipsis">
      encrypt_chunk
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.security.SecurityHandler.decrypt_chunk" class="md-nav__link">
    <span class="md-ellipsis">
      decrypt_chunk
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.security.SecurityHandler.build_encrypted_manifest" class="md-nav__link">
    <span class="md-ellipsis">
      build_encrypted_manifest
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.security.ChainedChecksum" class="md-nav__link">
    <span class="md-ellipsis">
      ChainedChecksum
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ChainedChecksum">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#p2p_copy.security.ChainedChecksum.next_hash" class="md-nav__link">
    <span class="md-ellipsis">
      next_hash
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.security.import_optional_security_libs" class="md-nav__link">
    <span class="md-ellipsis">
      import_optional_security_libs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#p2p_copy.compressor" class="md-nav__link">
    <span class="md-ellipsis">
      compressor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compressor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#p2p_copy.compressor.CompressMode" class="md-nav__link">
    <span class="md-ellipsis">
      CompressMode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.compressor.Compressor" class="md-nav__link">
    <span class="md-ellipsis">
      Compressor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Compressor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#p2p_copy.compressor.Compressor.determine_compression" class="md-nav__link">
    <span class="md-ellipsis">
      determine_compression
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.compressor.Compressor.compress" class="md-nav__link">
    <span class="md-ellipsis">
      compress
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.compressor.Compressor.decompress" class="md-nav__link">
    <span class="md-ellipsis">
      decompress
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.compressor.Compressor.set_decompression" class="md-nav__link">
    <span class="md-ellipsis">
      set_decompression
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#p2p_copy.protocol" class="md-nav__link">
    <span class="md-ellipsis">
      protocol
    </span>
  </a>
  
    <nav class="md-nav" aria-label="protocol">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#p2p_copy.protocol.Hello" class="md-nav__link">
    <span class="md-ellipsis">
      Hello
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.protocol.ManifestEntry" class="md-nav__link">
    <span class="md-ellipsis">
      ManifestEntry
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.protocol.Manifest" class="md-nav__link">
    <span class="md-ellipsis">
      Manifest
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.protocol.EncryptedManifest" class="md-nav__link">
    <span class="md-ellipsis">
      EncryptedManifest
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.protocol.ReceiverManifestEntry" class="md-nav__link">
    <span class="md-ellipsis">
      ReceiverManifestEntry
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.protocol.ReceiverManifest" class="md-nav__link">
    <span class="md-ellipsis">
      ReceiverManifest
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.protocol.EncryptedReceiverManifest" class="md-nav__link">
    <span class="md-ellipsis">
      EncryptedReceiverManifest
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.protocol.dumps" class="md-nav__link">
    <span class="md-ellipsis">
      dumps
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.protocol.loads" class="md-nav__link">
    <span class="md-ellipsis">
      loads
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.protocol.file_begin" class="md-nav__link">
    <span class="md-ellipsis">
      file_begin
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.protocol.encrypted_file_begin" class="md-nav__link">
    <span class="md-ellipsis">
      encrypted_file_begin
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.protocol.pack_chunk" class="md-nav__link">
    <span class="md-ellipsis">
      pack_chunk
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.protocol.unpack_chunk" class="md-nav__link">
    <span class="md-ellipsis">
      unpack_chunk
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#p2p_copy.io_utils" class="md-nav__link">
    <span class="md-ellipsis">
      io_utils
    </span>
  </a>
  
    <nav class="md-nav" aria-label="io_utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#p2p_copy.io_utils.read_in_chunks" class="md-nav__link">
    <span class="md-ellipsis">
      read_in_chunks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.io_utils.compute_chain_up_to" class="md-nav__link">
    <span class="md-ellipsis">
      compute_chain_up_to
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.io_utils.iter_manifest_entries" class="md-nav__link">
    <span class="md-ellipsis">
      iter_manifest_entries
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#p2p_copy.io_utils.ensure_dir" class="md-nav__link">
    <span class="md-ellipsis">
      ensure_dir
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="api-reference">API Reference</h1>
<p>This section documents the API of <code>p2p_copy</code>. Only the functions run_relay, send and receive are intended for users, others are mainly information for developers. For module structure, see <a href="../layout/">Module Layout</a>. Generated from source code docstrings.</p>
<p>&nbsp;</p>


<div class="doc doc-object doc-module">



<h2 id="p2p_copy_server" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">p2p_copy_server</span>


</h2>

    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="p2p_copy_server.run_relay" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">run_relay</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">run_relay</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">use_tls</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">certfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keyfile</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Run the WebSocket relay server for pairing and forwarding client connections.</p>
<p>This command starts a relay server that listens on the specified host/interface and port,
optionally secured with TLS (recommended for production). The server pairs
sender and receiver clients based on matching passphrase hashes, then forwards
bidirectional data streams without storing content. It handles exactly one
sender and one receiver per code hash, rejecting duplicates. Use for secure,
firewall-friendly (port 443) P2P transfers.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>host</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Host to bind to.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>port</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Port to bind to.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_tls</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to use TLS. Default is True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>certfile</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to TLS certificate file.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>keyfile</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to TLS key file.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If TLS is requested but certfile or keyfile is missing.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/p2p_copy_server/relay.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_relay</span><span class="p">(</span><span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                    <span class="n">use_tls</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="n">certfile</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">keyfile</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run the WebSocket relay server for pairing and forwarding client connections.</span>

<span class="sd">    This command starts a relay server that listens on the specified host/interface and port,</span>
<span class="sd">    optionally secured with TLS (recommended for production). The server pairs</span>
<span class="sd">    sender and receiver clients based on matching passphrase hashes, then forwards</span>
<span class="sd">    bidirectional data streams without storing content. It handles exactly one</span>
<span class="sd">    sender and one receiver per code hash, rejecting duplicates. Use for secure,</span>
<span class="sd">    firewall-friendly (port 443) P2P transfers.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    host : str</span>
<span class="sd">        Host to bind to.</span>
<span class="sd">    port : int</span>
<span class="sd">        Port to bind to.</span>
<span class="sd">    use_tls : bool, optional</span>
<span class="sd">        Whether to use TLS. Default is True.</span>
<span class="sd">    certfile : str, optional</span>
<span class="sd">        Path to TLS certificate file.</span>
<span class="sd">    keyfile : str, optional</span>
<span class="sd">        Path to TLS key file.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    RuntimeError</span>
<span class="sd">        If TLS is requested but certfile or keyfile is missing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ssl_ctx</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">use_tls</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">certfile</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">keyfile</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;TLS requested but certfile/keyfile missing&quot;</span><span class="p">)</span>
        <span class="n">ssl_ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLS_SERVER</span><span class="p">)</span>
        <span class="n">ssl_ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">certfile</span><span class="p">,</span> <span class="n">keyfile</span><span class="p">)</span>

    <span class="n">scheme</span> <span class="o">=</span> <span class="s2">&quot;wss&quot;</span> <span class="k">if</span> <span class="n">ssl_ctx</span> <span class="k">else</span> <span class="s2">&quot;ws&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Relay listening on </span><span class="si">{</span><span class="n">scheme</span><span class="si">}</span><span class="s2">://</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">host</span> <span class="o">!=</span> <span class="s2">&quot;localhost&quot;</span><span class="p">:</span>
        <span class="n">use_production_logger</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">serve</span><span class="p">(</span><span class="n">_handle</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">21</span><span class="p">,</span> <span class="n">ssl</span><span class="o">=</span><span class="n">ssl_ctx</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">()</span>  <span class="c1"># run forever</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p>&nbsp;</p>


<div class="doc doc-object doc-module">



<h2 id="p2p_copy.api" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">p2p_copy.api</span>


</h2>

    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="p2p_copy.api.send" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">send</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">send</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">encrypt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="n">CompressMode</span><span class="o">.</span><span class="n">auto</span><span class="p">,</span> <span class="n">resume</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Send one or more files or directories to a paired receiver via the relay server.</p>
<p>This command connects to the specified WebSocket relay server, authenticates using
the shared passphrase (hashed for pairing), and streams the provided files/directories
in chunks to the receiver. Supports directories by recursively including all files
in alphabetical order. Optional end-to-end encryption (AES-GCM) and compression
(Zstandard, auto-detected per file) can be enabled. If resume is enabled, it
coordinates with the receiver to skip complete files or append to partial ones
based on chained checksum verification.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>server</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The WebSocket server URL (ws:// or wss://).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>code</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The shared passphrase/code for pairing.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>files</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of files and/or directories to send.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>encrypt</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Enable end-to-end encryption. Default is False.
Receiver needs to use the same setting.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>compress</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="CompressMode (p2p_copy.compressor.CompressMode)" href="#p2p_copy.compressor.CompressMode">CompressMode</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Compression mode. Default is 'auto'.</p>
              </div>
            </td>
            <td>
                  <code><span title="p2p_copy.compressor.CompressMode.auto">auto</span></code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>resume</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Enable resume of partial transfers. Default is False.
If True, attempt to skip identical files and append
incomplete files based on receiver feedback.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Exit code: 0 on success, non-zero on error.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <ul>
<li>Supports resuming by comparing checksums of partial files.</li>
<li>Uses chunked streaming for large files.</li>
</ul>
</details>

            <details class="quote">
              <summary>Source code in <code>src/p2p_copy/api.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">send</span><span class="p">(</span><span class="n">server</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
               <span class="o">*</span><span class="p">,</span> <span class="n">encrypt</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
               <span class="n">compress</span><span class="p">:</span> <span class="n">CompressMode</span> <span class="o">=</span> <span class="n">CompressMode</span><span class="o">.</span><span class="n">auto</span><span class="p">,</span>
               <span class="n">resume</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Send one or more files or directories to a paired receiver via the relay server.</span>

<span class="sd">    This command connects to the specified WebSocket relay server, authenticates using</span>
<span class="sd">    the shared passphrase (hashed for pairing), and streams the provided files/directories</span>
<span class="sd">    in chunks to the receiver. Supports directories by recursively including all files</span>
<span class="sd">    in alphabetical order. Optional end-to-end encryption (AES-GCM) and compression</span>
<span class="sd">    (Zstandard, auto-detected per file) can be enabled. If resume is enabled, it</span>
<span class="sd">    coordinates with the receiver to skip complete files or append to partial ones</span>
<span class="sd">    based on chained checksum verification.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    server : str</span>
<span class="sd">        The WebSocket server URL (ws:// or wss://).</span>
<span class="sd">    code : str</span>
<span class="sd">        The shared passphrase/code for pairing.</span>
<span class="sd">    files : List[str]</span>
<span class="sd">        List of files and/or directories to send.</span>
<span class="sd">    encrypt : bool, optional</span>
<span class="sd">        Enable end-to-end encryption. Default is False.</span>
<span class="sd">        Receiver needs to use the same setting.</span>
<span class="sd">    compress : CompressMode, optional</span>
<span class="sd">        Compression mode. Default is &#39;auto&#39;.</span>
<span class="sd">    resume : bool, optional</span>
<span class="sd">        Enable resume of partial transfers. Default is False.</span>
<span class="sd">        If True, attempt to skip identical files and append</span>
<span class="sd">        incomplete files based on receiver feedback.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Exit code: 0 on success, non-zero on error.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Supports resuming by comparing checksums of partial files.</span>
<span class="sd">    - Uses chunked streaming for large files.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Closures to break up functions for readability</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">wait_for_receiver_ready</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ready_frame</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">ws</span><span class="o">.</span><span class="n">recv</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>  <span class="c1"># 300s Timeout</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ready_frame</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">ready</span> <span class="o">=</span> <span class="n">loads</span><span class="p">(</span><span class="n">ready_frame</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ready</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;ready&quot;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[p2p_copy] send(): unexpected frame after hello&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="mi">3</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[p2p_copy] send(): expected text frame after hello&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">3</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[p2p_copy] send(): timeout waiting for ready&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">3</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">wait_for_receiver_resume_manifest</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">ws</span><span class="o">.</span><span class="n">recv</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[p2p_copy] send(): timeout waiting for receiver_manifest&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">3</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="s2">&quot;enc_receiver_manifest&quot;</span> <span class="ow">and</span> <span class="n">encrypt</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">hidden</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="s2">&quot;hidden_manifest&quot;</span><span class="p">])</span>
                    <span class="n">m_str</span> <span class="o">=</span> <span class="n">secure</span><span class="o">.</span><span class="n">decrypt_chunk</span><span class="p">(</span><span class="n">hidden</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                    <span class="n">o</span> <span class="o">=</span> <span class="n">loads</span><span class="p">(</span><span class="n">m_str</span><span class="p">)</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[p2p_copy] send():  failed to decrypt encrypted receiver manifest&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="mi">3</span>

            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="s2">&quot;receiver_manifest&quot;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;entries&quot;</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">p</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span>
                        <span class="n">sz</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">])</span>
                        <span class="n">ch</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s2">&quot;chain_hex&quot;</span><span class="p">])</span>
                        <span class="n">resume_map</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sz</span><span class="p">,</span> <span class="n">ch</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[p2p_copy] send():  failed to read receiver manifest&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="mi">3</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">pairing_with_receiver</span><span class="p">():</span>
        <span class="k">await</span> <span class="n">ws</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">hello</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">receiver_not_ready</span> <span class="o">:=</span> <span class="k">await</span> <span class="n">wait_for_receiver_ready</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">receiver_not_ready</span>

        <span class="c1"># Send file infos to receiver</span>
        <span class="k">await</span> <span class="n">ws</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">manifest</span><span class="p">)</span>

        <span class="c1"># wait for receiver resume manifest (optionally encrypted)</span>
        <span class="k">if</span> <span class="n">resume</span> <span class="ow">and</span> <span class="p">(</span><span class="n">no_response_manifest</span> <span class="o">:=</span> <span class="k">await</span> <span class="n">wait_for_receiver_resume_manifest</span><span class="p">()):</span>
            <span class="k">return</span> <span class="n">no_response_manifest</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">determine_file_resume_point</span><span class="p">():</span>
        <span class="n">hint</span> <span class="o">=</span> <span class="n">resume_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rel_p</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">hint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">recv_size</span><span class="p">,</span> <span class="n">recv_chain</span> <span class="o">=</span> <span class="n">hint</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">recv_size</span> <span class="o">&lt;=</span> <span class="n">size</span><span class="p">:</span>
                <span class="n">hashed</span><span class="p">,</span> <span class="n">local_chain</span> <span class="o">=</span> <span class="k">await</span> <span class="n">compute_chain_up_to</span><span class="p">(</span><span class="n">abs_p</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">recv_size</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">hashed</span> <span class="o">==</span> <span class="n">recv_size</span> <span class="ow">and</span> <span class="n">local_chain</span> <span class="o">==</span> <span class="n">recv_chain</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">recv_size</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># mismatch -&gt; overwrite from scratch</span>
                    <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">send_file</span><span class="p">():</span>
        <span class="n">append_from</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Determine resume point (optional)</span>
        <span class="k">if</span> <span class="n">resume</span> <span class="ow">and</span> <span class="p">(</span><span class="n">append_from</span> <span class="o">:=</span> <span class="k">await</span> <span class="n">determine_file_resume_point</span><span class="p">())</span> <span class="o">==</span> <span class="n">size</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># Receiver already has identical file -&gt; skip</span>

        <span class="c1"># Open file and optionally seek resume point</span>
        <span class="k">with</span> <span class="n">abs_p</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">append_from</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">seek</span><span class="p">,</span> <span class="n">append_from</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Initialize per-transfer chain and sequence</span>
            <span class="n">chained_checksum</span> <span class="o">=</span> <span class="n">ChainedChecksum</span><span class="p">()</span>
            <span class="n">seq</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Determine whether to use compression by compressing the first chunk</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">,</span> <span class="n">CHUNK_SIZE</span><span class="p">)</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Compressor</span><span class="o">.</span><span class="n">determine_compression</span><span class="p">(</span><span class="n">compressor</span><span class="p">,</span> <span class="n">chunk</span><span class="p">)</span>

            <span class="c1"># Build the complete file info header</span>
            <span class="n">file_info</span> <span class="o">=</span> <span class="n">file_begin</span><span class="p">(</span><span class="n">rel_p</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span> <span class="n">size</span><span class="p">,</span> <span class="n">compressor</span><span class="o">.</span><span class="n">compression_type</span><span class="p">,</span> <span class="n">append_from</span><span class="o">=</span><span class="n">append_from</span><span class="p">)</span>

            <span class="c1"># Optionally encrypt the file info</span>
            <span class="k">if</span> <span class="n">encrypt</span><span class="p">:</span>
                <span class="n">enc_file_info</span> <span class="o">=</span> <span class="n">secure</span><span class="o">.</span><span class="n">encrypt_chunk</span><span class="p">(</span><span class="n">file_info</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
                <span class="n">file_info</span> <span class="o">=</span> <span class="n">encrypted_file_begin</span><span class="p">(</span><span class="n">enc_file_info</span><span class="p">)</span>

            <span class="c1"># Send file info header</span>
            <span class="k">await</span> <span class="n">ws</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">file_info</span><span class="p">)</span>

            <span class="c1"># Prepare the first frame, first chunk is optionally compressed and then encrypted</span>
            <span class="n">frame</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">pack_chunk</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">chained_checksum</span><span class="o">.</span><span class="n">next_hash</span><span class="p">(</span><span class="n">chunk</span><span class="p">),</span> <span class="n">secure</span><span class="o">.</span><span class="n">encrypt_chunk</span><span class="p">(</span><span class="n">chunk</span><span class="p">))</span>
            <span class="n">seq</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">next_frame</span><span class="p">():</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;prepares the next frame of a file to send, optionally compresses and encrypts&quot;&quot;&quot;</span>
                <span class="n">compressed_chunk</span> <span class="o">=</span> <span class="n">compressor</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                <span class="n">enc_chunk</span> <span class="o">=</span> <span class="n">secure</span><span class="o">.</span><span class="n">encrypt_chunk</span><span class="p">(</span><span class="n">compressed_chunk</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">pack_chunk</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">chained_checksum</span><span class="o">.</span><span class="n">next_hash</span><span class="p">(</span><span class="n">compressed_chunk</span><span class="p">),</span> <span class="n">enc_chunk</span><span class="p">)</span>

            <span class="c1"># Send remaining chunks</span>
            <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">read_in_chunks</span><span class="p">(</span><span class="n">fp</span><span class="p">):</span>
                <span class="c1"># Next frame gets prepared in a parallel thread</span>
                <span class="n">next_frame_coro</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span><span class="n">next_frame</span><span class="p">)</span>
                <span class="c1"># Send the current frame while next frame gets prepared</span>
                <span class="k">await</span> <span class="n">ws</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
                <span class="c1"># Complete the next frame</span>
                <span class="n">frame</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="k">await</span> <span class="n">next_frame_coro</span>
                <span class="n">seq</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Send the last frame</span>
        <span class="k">await</span> <span class="n">ws</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">ws</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">FILE_EOF</span><span class="p">)</span>

    <span class="c1"># End of Closures</span>

    <span class="c1"># Build manifest entries from given file list</span>
    <span class="n">resolved_file_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">iter_manifest_entries</span><span class="p">(</span><span class="n">files</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">resolved_file_list</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[p2p_copy] send(): no legal files where passed&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">3</span>

    <span class="n">entries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ManifestEntry</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ManifestEntry</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">rel</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">rel</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="ow">in</span>
                                    <span class="n">resolved_file_list</span><span class="p">]</span>

    <span class="c1"># Initialize security-handler, compressor</span>
    <span class="n">secure</span> <span class="o">=</span> <span class="n">SecurityHandler</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">encrypt</span><span class="p">)</span>
    <span class="n">compressor</span> <span class="o">=</span> <span class="n">Compressor</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">compress</span><span class="p">)</span>

    <span class="n">hello</span> <span class="o">=</span> <span class="n">Hello</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;hello&quot;</span><span class="p">,</span> <span class="n">code_hash_hex</span><span class="o">=</span><span class="n">secure</span><span class="o">.</span><span class="n">code_hash</span><span class="o">.</span><span class="n">hex</span><span class="p">(),</span> <span class="n">role</span><span class="o">=</span><span class="s2">&quot;sender&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
    <span class="n">manifest</span> <span class="o">=</span> <span class="n">Manifest</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;manifest&quot;</span><span class="p">,</span> <span class="n">resume</span><span class="o">=</span><span class="n">resume</span><span class="p">,</span> <span class="n">entries</span><span class="o">=</span><span class="n">entries</span><span class="p">)</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">encrypt</span><span class="p">:</span>  <span class="c1"># Optionally encrypt the manifest</span>
        <span class="n">manifest</span> <span class="o">=</span> <span class="n">secure</span><span class="o">.</span><span class="n">build_encrypted_manifest</span><span class="p">(</span><span class="n">manifest</span><span class="p">)</span>

    <span class="c1"># Connect to relay (disable WebSocket internal compression)</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">connect</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">21</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="k">as</span> <span class="n">ws</span><span class="p">:</span>
        <span class="c1"># Stores info returned by the sender about what files are already present</span>
        <span class="n">resume_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Attempt to connect and optionally exchange info with receiver</span>
        <span class="k">if</span> <span class="n">pairing_failed</span> <span class="o">:=</span> <span class="k">await</span> <span class="n">pairing_with_receiver</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">pairing_failed</span>

        <span class="c1"># Transfer each file</span>
        <span class="k">for</span> <span class="n">abs_p</span><span class="p">,</span> <span class="n">rel_p</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">resolved_file_list</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">send_file</span><span class="p">()</span>

        <span class="c1"># All done, send message to confirm the end of the copying process</span>
        <span class="k">await</span> <span class="n">ws</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">EOF</span><span class="p">)</span>
        <span class="c1"># Return non-error code</span>
        <span class="k">return</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="p2p_copy.api.receive" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">receive</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">receive</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">encrypt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Receive files from a paired sender via the relay server and write to the output directory.</p>
<p>This command connects to the relay server, pairs using the shared passphrase hash,
and receives a manifest of incoming files/directories. Files are written to the
output directory, preserving relative paths from the manifest. Supports optional
end-to-end decryption (matching sender's encryption) and decompression. If the
sender requests resume, this receiver reports existing file states (via checksums)
to enable skipping or appending.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>server</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The WebSocket server URL (ws:// or wss://).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>code</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The shared passphrase/code for pairing.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>encrypt</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Enable end-to-end encryption. Default is False.
Sender needs to use the same setting.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>out</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output directory. Default is current directory.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Exit code: 0 on success, non-zero on error.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <ul>
<li>Supports resume if sender requests it.</li>
<li>Writes files to the output directory, preserving relative paths.</li>
<li>Info on whether to resume and compress is received from the sender</li>
</ul>
</details>

            <details class="quote">
              <summary>Source code in <code>src/p2p_copy/api.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">receive</span><span class="p">(</span><span class="n">server</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="o">*</span><span class="p">,</span> <span class="n">encrypt</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                  <span class="n">out</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Receive files from a paired sender via the relay server and write to the output directory.</span>

<span class="sd">    This command connects to the relay server, pairs using the shared passphrase hash,</span>
<span class="sd">    and receives a manifest of incoming files/directories. Files are written to the</span>
<span class="sd">    output directory, preserving relative paths from the manifest. Supports optional</span>
<span class="sd">    end-to-end decryption (matching sender&#39;s encryption) and decompression. If the</span>
<span class="sd">    sender requests resume, this receiver reports existing file states (via checksums)</span>
<span class="sd">    to enable skipping or appending.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    server : str</span>
<span class="sd">        The WebSocket server URL (ws:// or wss://).</span>
<span class="sd">    code : str</span>
<span class="sd">        The shared passphrase/code for pairing.</span>
<span class="sd">    encrypt : bool, optional</span>
<span class="sd">        Enable end-to-end encryption. Default is False.</span>
<span class="sd">        Sender needs to use the same setting.</span>
<span class="sd">    out : str, optional</span>
<span class="sd">        Output directory. Default is current directory.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Exit code: 0 on success, non-zero on error.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Supports resume if sender requests it.</span>
<span class="sd">    - Writes files to the output directory, preserving relative paths.</span>
<span class="sd">    - Info on whether to resume and compress is received from the sender</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Closures to break up functions for readability</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">return_with_error_code</span><span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cur_fp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cur_fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[p2p_copy] receive(): </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">4</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_enc_manifest</span><span class="p">(</span><span class="n">o</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">nonce_hex</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nonce&quot;</span><span class="p">)</span>
            <span class="n">secure</span><span class="o">.</span><span class="n">nonce_hasher</span><span class="o">.</span><span class="n">next_hash</span><span class="p">(</span><span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">nonce_hex</span><span class="p">))</span>
            <span class="n">hidden</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="s2">&quot;hidden_manifest&quot;</span><span class="p">])</span>
            <span class="n">manifest_str</span> <span class="o">=</span> <span class="n">secure</span><span class="o">.</span><span class="n">decrypt_chunk</span><span class="p">(</span><span class="n">hidden</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">loads</span><span class="p">(</span><span class="n">manifest_str</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">handle_manifest</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>  <span class="c1"># Delegate to plain handler</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to decrypt manifest: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_manifest</span><span class="p">(</span><span class="n">o</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">resume</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resume&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resume</span><span class="p">:</span>
            <span class="n">entries</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;entries&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">reply_entries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ReceiverManifestEntry</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">rel</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">])</span>
                    <span class="n">local_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">out_dir</span> <span class="o">/</span> <span class="n">rel</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">local_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                        <span class="n">local_size</span> <span class="o">=</span> <span class="n">local_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span>
                        <span class="k">if</span> <span class="n">local_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">hashed</span><span class="p">,</span> <span class="n">chain_b</span> <span class="o">=</span> <span class="k">await</span> <span class="n">compute_chain_up_to</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span>
                            <span class="n">resume_known</span><span class="p">[</span><span class="n">rel</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()]</span> <span class="o">=</span> <span class="p">(</span><span class="n">hashed</span><span class="p">,</span> <span class="n">chain_b</span><span class="p">)</span>
                            <span class="n">reply_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="n">ReceiverManifestEntry</span><span class="p">(</span>
                                    <span class="n">path</span><span class="o">=</span><span class="n">rel</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
                                    <span class="n">size</span><span class="o">=</span><span class="n">hashed</span><span class="p">,</span>
                                    <span class="n">chain_hex</span><span class="o">=</span><span class="n">chain_b</span><span class="o">.</span><span class="n">hex</span><span class="p">(),</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>  <span class="c1"># Skip bad entries</span>

            <span class="k">if</span> <span class="n">encrypt</span><span class="p">:</span>
                <span class="n">clear</span> <span class="o">=</span> <span class="n">ReceiverManifest</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;receiver_manifest&quot;</span><span class="p">,</span> <span class="n">entries</span><span class="o">=</span><span class="n">reply_entries</span><span class="p">)</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
                <span class="n">hidden</span> <span class="o">=</span> <span class="n">secure</span><span class="o">.</span><span class="n">encrypt_chunk</span><span class="p">(</span><span class="n">clear</span><span class="p">)</span>
                <span class="n">reply</span> <span class="o">=</span> <span class="n">EncryptedReceiverManifest</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;enc_receiver_manifest&quot;</span><span class="p">,</span>
                    <span class="n">hidden_manifest</span><span class="o">=</span><span class="n">hidden</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
                <span class="p">)</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
                <span class="k">await</span> <span class="n">ws</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ws</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">ReceiverManifest</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;receiver_manifest&quot;</span><span class="p">,</span> <span class="n">entries</span><span class="o">=</span><span class="n">reply_entries</span><span class="p">)</span><span class="o">.</span><span class="n">to_json</span><span class="p">())</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_enc_file</span><span class="p">(</span><span class="n">o</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hidden</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="s2">&quot;hidden_file&quot;</span><span class="p">])</span>
            <span class="n">file_str</span> <span class="o">=</span> <span class="n">secure</span><span class="o">.</span><span class="n">decrypt_chunk</span><span class="p">(</span><span class="n">hidden</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">loads</span><span class="p">(</span><span class="n">file_str</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">handle_file</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to decrypt file info: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_file</span><span class="p">(</span><span class="n">o</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">nonlocal</span> <span class="n">cur_fp</span><span class="p">,</span> <span class="n">cur_expected_size</span><span class="p">,</span> <span class="n">cur_seq_expected</span><span class="p">,</span> <span class="n">bytes_written</span><span class="p">,</span> <span class="n">compressor</span><span class="p">,</span> <span class="n">chained_checksum</span>
        <span class="k">if</span> <span class="n">cur_fp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Got new file while previous still open&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rel_path</span> <span class="o">=</span> <span class="n">o</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span>
            <span class="n">total_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;size&quot;</span><span class="p">)</span>
            <span class="n">compression</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;compression&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">)</span>
            <span class="n">append_from</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;append_from&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bad file header: </span><span class="si">{</span><span class="n">o</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">dest</span> <span class="o">=</span> <span class="p">(</span><span class="n">out_dir</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">rel_path</span><span class="p">))</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
        <span class="n">ensure_dir</span><span class="p">(</span><span class="n">dest</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>

        <span class="n">open_mode</span> <span class="o">=</span> <span class="s2">&quot;wb&quot;</span>
        <span class="n">expected_remaining</span> <span class="o">=</span> <span class="n">total_size</span>
        <span class="k">if</span> <span class="n">append_from</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">dest</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">dest</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">local_size</span> <span class="o">=</span> <span class="n">dest</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">append_from</span> <span class="o">&lt;=</span> <span class="n">total_size</span> <span class="ow">and</span> <span class="n">local_size</span> <span class="o">==</span> <span class="n">append_from</span><span class="p">:</span>
                <span class="n">open_mode</span> <span class="o">=</span> <span class="s2">&quot;ab&quot;</span>
                <span class="n">expected_remaining</span> <span class="o">=</span> <span class="n">total_size</span> <span class="o">-</span> <span class="n">append_from</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">expected_remaining</span> <span class="o">=</span> <span class="n">total_size</span>

        <span class="n">cur_fp</span> <span class="o">=</span> <span class="n">dest</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">open_mode</span><span class="p">)</span>
        <span class="n">cur_expected_size</span> <span class="o">=</span> <span class="n">expected_remaining</span>
        <span class="n">cur_seq_expected</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">bytes_written</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">compressor</span><span class="o">.</span><span class="n">set_decompression</span><span class="p">(</span><span class="n">compression</span><span class="p">)</span>
        <span class="n">chained_checksum</span> <span class="o">=</span> <span class="n">ChainedChecksum</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_file_eof</span><span class="p">(</span><span class="n">o</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">nonlocal</span> <span class="n">cur_fp</span>
        <span class="k">if</span> <span class="n">cur_fp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Got file_eof without open file&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cur_expected_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">bytes_written</span> <span class="o">!=</span> <span class="n">cur_expected_size</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Size mismatch: </span><span class="si">{</span><span class="n">bytes_written</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="n">cur_expected_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">cur_fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">cur_fp</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_chunk</span><span class="p">():</span>
        <span class="k">nonlocal</span> <span class="n">bytes_written</span><span class="p">,</span> <span class="n">cur_seq_expected</span>
        <span class="k">if</span> <span class="n">cur_fp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unexpected binary data without open file&quot;</span><span class="p">)</span>
        <span class="n">seq</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">unpack_chunk</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">seq</span> <span class="o">!=</span> <span class="n">cur_seq_expected</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sequence mismatch: </span><span class="si">{</span><span class="n">seq</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="n">cur_seq_expected</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">raw_payload</span> <span class="o">=</span> <span class="n">secure</span><span class="o">.</span><span class="n">decrypt_chunk</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span> <span class="k">if</span> <span class="n">encrypt</span> <span class="k">else</span> <span class="n">payload</span>
        <span class="k">if</span> <span class="n">chained_checksum</span><span class="o">.</span><span class="n">next_hash</span><span class="p">(</span><span class="n">raw_payload</span><span class="p">)</span> <span class="o">!=</span> <span class="n">chain</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Chained checksum mismatch&quot;</span><span class="p">)</span>

        <span class="n">chunk</span> <span class="o">=</span> <span class="n">compressor</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">raw_payload</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span><span class="n">cur_fp</span><span class="o">.</span><span class="n">write</span><span class="p">,</span> <span class="n">chunk</span><span class="p">)</span>

        <span class="n">bytes_written</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
        <span class="n">cur_seq_expected</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_eof</span><span class="p">(</span><span class="n">o</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">StopAsyncIteration</span>  <span class="c1"># Break the loop cleanly</span>

    <span class="c1"># Frame type dispatcher</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">dispatch_frame</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">)):</span>
            <span class="k">await</span> <span class="n">handle_chunk</span><span class="p">()</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown frame type&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">loads</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>

            <span class="n">handlers</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;enc_manifest&quot;</span><span class="p">:</span> <span class="n">handle_enc_manifest</span> <span class="k">if</span> <span class="n">encrypt</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;manifest&quot;</span><span class="p">:</span> <span class="n">handle_manifest</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">encrypt</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;enc_file&quot;</span><span class="p">:</span> <span class="n">handle_enc_file</span> <span class="k">if</span> <span class="n">encrypt</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">handle_file</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">encrypt</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;file_eof&quot;</span><span class="p">:</span> <span class="n">handle_file_eof</span><span class="p">,</span>
                <span class="s2">&quot;eof&quot;</span><span class="p">:</span> <span class="n">handle_eof</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="n">handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">handler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected control: </span><span class="si">{</span><span class="n">o</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">handler</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>

    <span class="c1"># End of Closures</span>

    <span class="n">out_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">out</span> <span class="ow">or</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>
    <span class="n">ensure_dir</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span>

    <span class="n">secure</span> <span class="o">=</span> <span class="n">SecurityHandler</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">encrypt</span><span class="p">)</span>
    <span class="n">hello</span> <span class="o">=</span> <span class="n">Hello</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;hello&quot;</span><span class="p">,</span> <span class="n">code_hash_hex</span><span class="o">=</span><span class="n">secure</span><span class="o">.</span><span class="n">code_hash</span><span class="o">.</span><span class="n">hex</span><span class="p">(),</span> <span class="n">role</span><span class="o">=</span><span class="s2">&quot;receiver&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>

    <span class="c1"># Receiver state</span>
    <span class="n">cur_fp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BinaryIO</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">cur_expected_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">cur_seq_expected</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">bytes_written</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">chained_checksum</span> <span class="o">=</span> <span class="n">ChainedChecksum</span><span class="p">()</span>
    <span class="n">compressor</span> <span class="o">=</span> <span class="n">Compressor</span><span class="p">()</span>
    <span class="n">resume_known</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">connect</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">21</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="k">as</span> <span class="n">ws</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">ws</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">hello</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">ws</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">dispatch_frame</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">StopAsyncIteration</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># Normal EOF</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">return_with_error_code</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">cur_fp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">return_with_error_code</span><span class="p">(</span><span class="s2">&quot;Stream ended while file open&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p>&nbsp;</p>


<div class="doc doc-object doc-module">



<h2 id="p2p_copy.security" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">p2p_copy.security</span>


</h2>

    <div class="doc doc-contents first">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="p2p_copy.security.SecurityHandler" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">SecurityHandler</span>


</h3>


    <div class="doc doc-contents ">


        <p>Handle security operations like hashing, encryption, and decryption for transfers.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>code</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The shared passphrase/code.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>encrypt</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to enable end-to-end encryption.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/p2p_copy/security.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SecurityHandler</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handle security operations like hashing, encryption, and decryption for transfers.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    code : str</span>
<span class="sd">        The shared passphrase/code.</span>
<span class="sd">    encrypt : bool</span>
<span class="sd">        Whether to enable end-to-end encryption.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">encrypt</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="n">encrypt</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">encrypt</span><span class="p">:</span>
            <span class="n">import_optional_security_libs</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">code_hash</span> <span class="o">=</span> <span class="n">_get_argon2_hash</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;code_hash used for hello-match&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nonce_hasher</span> <span class="o">=</span> <span class="n">ChainedChecksum</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">AESGCM</span><span class="p">(</span><span class="n">_get_argon2_hash</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;cipher used for E2E-encryption&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">code_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">encrypt_chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Encrypt a chunk if encryption is enabled.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        chunk : bytes</span>
<span class="sd">            The chunk to encrypt.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bytes</span>
<span class="sd">            The encrypted chunk, or original if not encrypted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">encrypt</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nonce_hasher</span><span class="o">.</span><span class="n">next_hash</span><span class="p">(),</span> <span class="n">chunk</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">chunk</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">decrypt_chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decrypt a chunk if encryption is enabled.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        chunk : bytes</span>
<span class="sd">            The chunk to decrypt.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bytes</span>
<span class="sd">            The decrypted chunk, or original if not encrypted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">encrypt</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cipher</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nonce_hasher</span><span class="o">.</span><span class="n">next_hash</span><span class="p">(),</span> <span class="n">chunk</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">chunk</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">build_encrypted_manifest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manifest</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build an encrypted manifest for secure transmission.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        manifest : str</span>
<span class="sd">            The plaintext manifest JSON.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            The JSON-serialized EncryptedManifest.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start_nonce</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nonce_hasher</span><span class="o">.</span><span class="n">next_hash</span><span class="p">(</span><span class="n">start_nonce</span><span class="p">)</span>
        <span class="n">enc_manifest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encrypt_chunk</span><span class="p">(</span><span class="n">manifest</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">EncryptedManifest</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;enc_manifest&quot;</span><span class="p">,</span>
            <span class="n">nonce</span><span class="o">=</span><span class="n">start_nonce</span><span class="o">.</span><span class="n">hex</span><span class="p">(),</span>
            <span class="n">hidden_manifest</span><span class="o">=</span><span class="n">enc_manifest</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="p2p_copy.security.SecurityHandler.encrypt_chunk" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">encrypt_chunk</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">encrypt_chunk</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Encrypt a chunk if encryption is enabled.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>chunk</code>
            </td>
            <td>
                  <code><span title="bytes">bytes</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The chunk to encrypt.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="bytes">bytes</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The encrypted chunk, or original if not encrypted.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/p2p_copy/security.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">encrypt_chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Encrypt a chunk if encryption is enabled.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    chunk : bytes</span>
<span class="sd">        The chunk to encrypt.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bytes</span>
<span class="sd">        The encrypted chunk, or original if not encrypted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">encrypt</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nonce_hasher</span><span class="o">.</span><span class="n">next_hash</span><span class="p">(),</span> <span class="n">chunk</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chunk</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="p2p_copy.security.SecurityHandler.decrypt_chunk" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">decrypt_chunk</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">decrypt_chunk</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Decrypt a chunk if encryption is enabled.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>chunk</code>
            </td>
            <td>
                  <code><span title="bytes">bytes</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The chunk to decrypt.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="bytes">bytes</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The decrypted chunk, or original if not encrypted.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/p2p_copy/security.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">decrypt_chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decrypt a chunk if encryption is enabled.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    chunk : bytes</span>
<span class="sd">        The chunk to decrypt.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bytes</span>
<span class="sd">        The decrypted chunk, or original if not encrypted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">encrypt</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cipher</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nonce_hasher</span><span class="o">.</span><span class="n">next_hash</span><span class="p">(),</span> <span class="n">chunk</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chunk</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="p2p_copy.security.SecurityHandler.build_encrypted_manifest" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">build_encrypted_manifest</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">build_encrypted_manifest</span><span class="p">(</span><span class="n">manifest</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Build an encrypted manifest for secure transmission.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>manifest</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The plaintext manifest JSON.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The JSON-serialized EncryptedManifest.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/p2p_copy/security.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_encrypted_manifest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manifest</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build an encrypted manifest for secure transmission.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    manifest : str</span>
<span class="sd">        The plaintext manifest JSON.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        The JSON-serialized EncryptedManifest.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start_nonce</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nonce_hasher</span><span class="o">.</span><span class="n">next_hash</span><span class="p">(</span><span class="n">start_nonce</span><span class="p">)</span>
    <span class="n">enc_manifest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encrypt_chunk</span><span class="p">(</span><span class="n">manifest</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">EncryptedManifest</span><span class="p">(</span>
        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;enc_manifest&quot;</span><span class="p">,</span>
        <span class="n">nonce</span><span class="o">=</span><span class="n">start_nonce</span><span class="o">.</span><span class="n">hex</span><span class="p">(),</span>
        <span class="n">hidden_manifest</span><span class="o">=</span><span class="n">enc_manifest</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
    <span class="p">)</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="p2p_copy.security.ChainedChecksum" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">ChainedChecksum</span>


</h3>


    <div class="doc doc-contents ">


        <p>Generate chained SHA-256 checksums over sequential payloads.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>seed</code>
            </td>
            <td>
                  <code><span title="bytes">bytes</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initial seed for the chain. Default is empty bytes.</p>
              </div>
            </td>
            <td>
                  <code>b&#39;&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/p2p_copy/security.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ChainedChecksum</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate chained SHA-256 checksums over sequential payloads.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    seed : bytes, optional</span>
<span class="sd">        Initial seed for the chain. Default is empty bytes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_chain</span> <span class="o">=</span> <span class="n">seed</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">next_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the next hash in the chain: sha256(prev_chain || payload).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        payload : bytes, optional</span>
<span class="sd">            Data to include in this hash. Default is empty.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bytes</span>
<span class="sd">            The 32-byte hash, which becomes the new prev_chain.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">()</span>
        <span class="n">h</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_chain</span><span class="p">)</span>
        <span class="n">h</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_chain</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_chain</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="p2p_copy.security.ChainedChecksum.next_hash" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">next_hash</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">next_hash</span><span class="p">(</span><span class="n">payload</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Compute the next hash in the chain: sha256(prev_chain || payload).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>payload</code>
            </td>
            <td>
                  <code><span title="bytes">bytes</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Data to include in this hash. Default is empty.</p>
              </div>
            </td>
            <td>
                  <code>b&#39;&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="bytes">bytes</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The 32-byte hash, which becomes the new prev_chain.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/p2p_copy/security.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">next_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the next hash in the chain: sha256(prev_chain || payload).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    payload : bytes, optional</span>
<span class="sd">        Data to include in this hash. Default is empty.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bytes</span>
<span class="sd">        The 32-byte hash, which becomes the new prev_chain.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">()</span>
    <span class="n">h</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_chain</span><span class="p">)</span>
    <span class="n">h</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">prev_chain</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_chain</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h3 id="p2p_copy.security.import_optional_security_libs" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">import_optional_security_libs</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">import_optional_security_libs</span><span class="p">()</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Import optional security libraries (argon2-cffi, cryptography) if encryption is used.</p>


            <details class="quote">
              <summary>Source code in <code>src/p2p_copy/security.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">import_optional_security_libs</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Import optional security libraries (argon2-cffi, cryptography) if encryption is used.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">hash_secret_raw</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">AESGCM</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># security libs are needed if encryption is used</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">argon2.low_level</span><span class="w"> </span><span class="kn">import</span> <span class="n">hash_secret_raw</span><span class="p">,</span> <span class="n">Type</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives.ciphers.aead</span><span class="w"> </span><span class="kn">import</span> <span class="n">AESGCM</span>
    <span class="k">except</span> <span class="ne">ModuleNotFoundError</span> <span class="k">as</span> <span class="n">E</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ModuleNotFoundError</span><span class="p">(</span>
            <span class="n">E</span><span class="o">.</span><span class="n">msg</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">To use encryption optional security libs are needed (pip install p2p-copy[security])&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p>&nbsp;</p>


<div class="doc doc-object doc-module">



<h2 id="p2p_copy.compressor" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">p2p_copy.compressor</span>


</h2>

    <div class="doc doc-contents first">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="p2p_copy.compressor.CompressMode" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">CompressMode</span>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="str">str</span></code>, <code><span title="enum.Enum">Enum</span></code></p>


        <p>Enumeration of compression modes.</p>








              <details class="quote">
                <summary>Source code in <code>src/p2p_copy/compressor.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CompressMode</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enumeration of compression modes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">auto</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
    <span class="n">on</span> <span class="o">=</span> <span class="s2">&quot;on&quot;</span>
    <span class="n">off</span> <span class="o">=</span> <span class="s2">&quot;off&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="p2p_copy.compressor.Compressor" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">Compressor</span>


</h3>


    <div class="doc doc-contents ">


        <p>Handle compression and decompression of chunks using Zstandard.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>mode</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="CompressMode (p2p_copy.compressor.CompressMode)" href="#p2p_copy.compressor.CompressMode">CompressMode</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Compression mode. Default is 'auto'.</p>
              </div>
            </td>
            <td>
                  <code><span title="p2p_copy.compressor.CompressMode.auto">auto</span></code>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/p2p_copy/compressor.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Compressor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handle compression and decompression of chunks using Zstandard.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mode : CompressMode, optional</span>
<span class="sd">        Compression mode. Default is &#39;auto&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">CompressMode</span> <span class="o">=</span> <span class="n">CompressMode</span><span class="o">.</span><span class="n">auto</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cctx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">zstd</span><span class="o">.</span><span class="n">ZstdCompressor</span><span class="p">]</span> <span class="o">=</span> <span class="n">zstd</span><span class="o">.</span><span class="n">ZstdCompressor</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">!=</span> <span class="n">CompressMode</span><span class="o">.</span><span class="n">off</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dctx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">zstd</span><span class="o">.</span><span class="n">ZstdDecompressor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_compression</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">CompressMode</span><span class="o">.</span><span class="n">on</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compression_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;zstd&quot;</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">CompressMode</span><span class="o">.</span><span class="n">on</span> <span class="k">else</span> <span class="s2">&quot;none&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">determine_compression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first_chunk</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine if compression should be used based on the first chunk (auto mode).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        first_chunk : bytes</span>
<span class="sd">            The first chunk of data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bytes</span>
<span class="sd">            The (possibly compressed) first chunk.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">CompressMode</span><span class="o">.</span><span class="n">off</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">first_chunk</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">compressed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cctx</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">first_chunk</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">CompressMode</span><span class="o">.</span><span class="n">on</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">compressed</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">CompressMode</span><span class="o">.</span><span class="n">auto</span><span class="p">:</span>
                <span class="c1"># Auto mode: test first chunk</span>
                <span class="n">compression_ratio</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">compressed</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">first_chunk</span><span class="p">)</span> <span class="k">if</span> <span class="n">first_chunk</span> <span class="k">else</span> <span class="mf">1.0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">use_compression</span> <span class="o">=</span> <span class="n">compression_ratio</span> <span class="o">&lt;</span> <span class="mf">0.95</span>  <span class="c1"># Enable if compressed size &lt; 95% of original</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compression_type</span> <span class="o">=</span> <span class="s2">&quot;zstd&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_compression</span> <span class="k">else</span> <span class="s2">&quot;none&quot;</span>
                <span class="k">return</span> <span class="n">compressed</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_compression</span> <span class="k">else</span> <span class="n">first_chunk</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compress a chunk if compression is enabled.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        chunk : bytes</span>
<span class="sd">            The chunk to compress.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bytes</span>
<span class="sd">            The compressed or original chunk.</span>
<span class="sd">        &quot;&quot;&quot;</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compress a chunk if compression is enabled.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_compression</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cctx</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cctx</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">chunk</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">decompress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decompress a chunk if decompression is set up.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        chunk : bytes</span>
<span class="sd">            The chunk to decompress.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bytes</span>
<span class="sd">            The decompressed or original chunk.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dctx</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dctx</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">chunk</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_decompression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compression_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set up the decompressor based on the compression type.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        compression_type : str</span>
<span class="sd">            The type of compression (&#39;zstd&#39; or &#39;none&#39;).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dctx</span> <span class="o">=</span> <span class="n">zstd</span><span class="o">.</span><span class="n">ZstdDecompressor</span><span class="p">()</span> <span class="k">if</span> <span class="n">compression_type</span> <span class="o">==</span> <span class="s2">&quot;zstd&quot;</span> <span class="k">else</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="p2p_copy.compressor.Compressor.determine_compression" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">determine_compression</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">determine_compression</span><span class="p">(</span><span class="n">first_chunk</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Determine if compression should be used based on the first chunk (auto mode).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>first_chunk</code>
            </td>
            <td>
                  <code><span title="bytes">bytes</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The first chunk of data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="bytes">bytes</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The (possibly compressed) first chunk.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/p2p_copy/compressor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">determine_compression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first_chunk</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine if compression should be used based on the first chunk (auto mode).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    first_chunk : bytes</span>
<span class="sd">        The first chunk of data.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bytes</span>
<span class="sd">        The (possibly compressed) first chunk.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">CompressMode</span><span class="o">.</span><span class="n">off</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">first_chunk</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">compressed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cctx</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">first_chunk</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">CompressMode</span><span class="o">.</span><span class="n">on</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">compressed</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">CompressMode</span><span class="o">.</span><span class="n">auto</span><span class="p">:</span>
            <span class="c1"># Auto mode: test first chunk</span>
            <span class="n">compression_ratio</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">compressed</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">first_chunk</span><span class="p">)</span> <span class="k">if</span> <span class="n">first_chunk</span> <span class="k">else</span> <span class="mf">1.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_compression</span> <span class="o">=</span> <span class="n">compression_ratio</span> <span class="o">&lt;</span> <span class="mf">0.95</span>  <span class="c1"># Enable if compressed size &lt; 95% of original</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compression_type</span> <span class="o">=</span> <span class="s2">&quot;zstd&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_compression</span> <span class="k">else</span> <span class="s2">&quot;none&quot;</span>
            <span class="k">return</span> <span class="n">compressed</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_compression</span> <span class="k">else</span> <span class="n">first_chunk</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="p2p_copy.compressor.Compressor.compress" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">compress</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">compress</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Compress a chunk if compression is enabled.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>chunk</code>
            </td>
            <td>
                  <code><span title="bytes">bytes</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The chunk to compress.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="bytes">bytes</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The compressed or original chunk.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/p2p_copy/compressor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compress a chunk if compression is enabled.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    chunk : bytes</span>
<span class="sd">        The chunk to compress.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bytes</span>
<span class="sd">        The compressed or original chunk.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compress a chunk if compression is enabled.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_compression</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cctx</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cctx</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chunk</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="p2p_copy.compressor.Compressor.decompress" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">decompress</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">decompress</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Decompress a chunk if decompression is set up.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>chunk</code>
            </td>
            <td>
                  <code><span title="bytes">bytes</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The chunk to decompress.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="bytes">bytes</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The decompressed or original chunk.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/p2p_copy/compressor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">decompress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decompress a chunk if decompression is set up.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    chunk : bytes</span>
<span class="sd">        The chunk to decompress.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bytes</span>
<span class="sd">        The decompressed or original chunk.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dctx</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dctx</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chunk</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="p2p_copy.compressor.Compressor.set_decompression" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">set_decompression</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">set_decompression</span><span class="p">(</span><span class="n">compression_type</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Set up the decompressor based on the compression type.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>compression_type</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The type of compression ('zstd' or 'none').</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/p2p_copy/compressor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_decompression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compression_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set up the decompressor based on the compression type.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    compression_type : str</span>
<span class="sd">        The type of compression (&#39;zstd&#39; or &#39;none&#39;).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">dctx</span> <span class="o">=</span> <span class="n">zstd</span><span class="o">.</span><span class="n">ZstdDecompressor</span><span class="p">()</span> <span class="k">if</span> <span class="n">compression_type</span> <span class="o">==</span> <span class="s2">&quot;zstd&quot;</span> <span class="k">else</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div><p>&nbsp;</p>


<div class="doc doc-object doc-module">



<h2 id="p2p_copy.protocol" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">p2p_copy.protocol</span>


</h2>

    <div class="doc doc-contents first">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="p2p_copy.protocol.Hello" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">Hello</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">


        <p>Hello message for connection initiation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>type</code>
            </td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;hello&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Message type.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>code_hash_hex</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hex-encoded hash of the shared code.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>role</code>
            </td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;sender&#39;, &#39;receiver&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The role of this client.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/p2p_copy/protocol.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Hello</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Hello message for connection initiation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    type : Literal[&quot;hello&quot;]</span>
<span class="sd">        Message type.</span>
<span class="sd">    code_hash_hex : str</span>
<span class="sd">        Hex-encoded hash of the shared code.</span>
<span class="sd">    role : Literal[&quot;sender&quot;, &quot;receiver&quot;]</span>
<span class="sd">        The role of this client.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;hello&quot;</span><span class="p">]</span>
    <span class="n">code_hash_hex</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">role</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;sender&quot;</span><span class="p">,</span> <span class="s2">&quot;receiver&quot;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;hello&quot;</span><span class="p">,</span> <span class="s2">&quot;code_hash_hex&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">code_hash_hex</span><span class="p">,</span> <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">role</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="p2p_copy.protocol.ManifestEntry" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">ManifestEntry</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">


        <p>Entry in a file manifest.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Relative path of the file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>File size in bytes.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/p2p_copy/protocol.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ManifestEntry</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Entry in a file manifest.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        Relative path of the file.</span>
<span class="sd">    size : int</span>
<span class="sd">        File size in bytes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">size</span><span class="p">:</span> <span class="nb">int</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="p2p_copy.protocol.Manifest" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">Manifest</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">


        <p>Manifest of files to send.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>type</code>
            </td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;manifest&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Message type.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>entries</code>
            </td>
            <td>
                  <code><span title="typing.Sequence">Sequence</span>[<a class="autorefs autorefs-internal" title="ManifestEntry


  
      dataclass
   (p2p_copy.protocol.ManifestEntry)" href="#p2p_copy.protocol.ManifestEntry">ManifestEntry</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of file entries.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>resume</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to enable resume. Default is False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/p2p_copy/protocol.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Manifest</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Manifest of files to send.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    type : Literal[&quot;manifest&quot;]</span>
<span class="sd">        Message type.</span>
<span class="sd">    entries : Sequence[ManifestEntry]</span>
<span class="sd">        List of file entries.</span>
<span class="sd">    resume : bool, optional</span>
<span class="sd">        Whether to enable resume. Default is False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;manifest&quot;</span><span class="p">]</span>
    <span class="n">entries</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ManifestEntry</span><span class="p">]</span>
    <span class="n">resume</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dumps</span><span class="p">({</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;manifest&quot;</span><span class="p">,</span>
            <span class="s2">&quot;resume&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">resume</span><span class="p">,</span>
            <span class="s2">&quot;entries&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">asdict</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">]</span>
        <span class="p">})</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="p2p_copy.protocol.EncryptedManifest" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">EncryptedManifest</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">


        <p>Encrypted manifest for secure transmission.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>type</code>
            </td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;enc_manifest&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Message type.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nonce</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hex-encoded nonce that is used as random seed.
Further nonces are based on this and used for encryption.
Must be shared with receiver so it can decrypt accordingly.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hidden_manifest</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hex-encoded encrypted manifest.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/p2p_copy/protocol.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">EncryptedManifest</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Encrypted manifest for secure transmission.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    type : Literal[&quot;enc_manifest&quot;]</span>
<span class="sd">        Message type.</span>
<span class="sd">    nonce : str</span>
<span class="sd">        Hex-encoded nonce that is used as random seed.</span>
<span class="sd">        Further nonces are based on this and used for encryption.</span>
<span class="sd">        Must be shared with receiver so it can decrypt accordingly.</span>
<span class="sd">    hidden_manifest : str</span>
<span class="sd">        Hex-encoded encrypted manifest.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;enc_manifest&quot;</span><span class="p">]</span>
    <span class="n">nonce</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">hidden_manifest</span><span class="p">:</span> <span class="nb">str</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dumps</span><span class="p">({</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;enc_manifest&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nonce&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonce</span><span class="p">,</span>
            <span class="s2">&quot;hidden_manifest&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_manifest</span>
        <span class="p">})</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="p2p_copy.protocol.ReceiverManifestEntry" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">ReceiverManifestEntry</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">


        <p>Receiver's report of existing file state for resume.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Relative path.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Bytes already present.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>chain_hex</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hex-encoded chained checksum up to 'size'.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/p2p_copy/protocol.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ReceiverManifestEntry</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Receiver&#39;s report of existing file state for resume.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        Relative path.</span>
<span class="sd">    size : int</span>
<span class="sd">        Bytes already present.</span>
<span class="sd">    chain_hex : str</span>
<span class="sd">        Hex-encoded chained checksum up to &#39;size&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">size</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">chain_hex</span><span class="p">:</span> <span class="nb">str</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="p2p_copy.protocol.ReceiverManifest" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">ReceiverManifest</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">


        <p>Manifest from receiver reporting existing files.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>type</code>
            </td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;receiver_manifest&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Message type.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>entries</code>
            </td>
            <td>
                  <code><span title="typing.Sequence">Sequence</span>[<a class="autorefs autorefs-internal" title="ReceiverManifestEntry


  
      dataclass
   (p2p_copy.protocol.ReceiverManifestEntry)" href="#p2p_copy.protocol.ReceiverManifestEntry">ReceiverManifestEntry</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of entries.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/p2p_copy/protocol.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ReceiverManifest</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Manifest from receiver reporting existing files.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    type : Literal[&quot;receiver_manifest&quot;]</span>
<span class="sd">        Message type.</span>
<span class="sd">    entries : Sequence[ReceiverManifestEntry]</span>
<span class="sd">        List of entries.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;receiver_manifest&quot;</span><span class="p">]</span>
    <span class="n">entries</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ReceiverManifestEntry</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dumps</span><span class="p">({</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;receiver_manifest&quot;</span><span class="p">,</span>
            <span class="s2">&quot;entries&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">asdict</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">]</span>
        <span class="p">})</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="p2p_copy.protocol.EncryptedReceiverManifest" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">EncryptedReceiverManifest</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">


        <p>Encrypted receiver manifest.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>type</code>
            </td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;enc_receiver_manifest&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Message type.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hidden_manifest</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hex-encoded encrypted manifest.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/p2p_copy/protocol.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">EncryptedReceiverManifest</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Encrypted receiver manifest.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    type : Literal[&quot;enc_receiver_manifest&quot;]</span>
<span class="sd">        Message type.</span>
<span class="sd">    hidden_manifest : str</span>
<span class="sd">        Hex-encoded encrypted manifest.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;enc_receiver_manifest&quot;</span><span class="p">]</span>
    <span class="n">hidden_manifest</span><span class="p">:</span> <span class="nb">str</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dumps</span><span class="p">({</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;enc_receiver_manifest&quot;</span><span class="p">,</span>
            <span class="s2">&quot;hidden_manifest&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_manifest</span>
        <span class="p">})</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h3 id="p2p_copy.protocol.dumps" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">dumps</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">dumps</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>JSON-dump a message with compact separators.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>msg</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The message to serialize.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Compact JSON string.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/p2p_copy/protocol.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">dumps</span><span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    JSON-dump a message with compact separators.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msg : Dict[str, Any]</span>
<span class="sd">        The message to serialize.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Compact JSON string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">),</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="p2p_copy.protocol.loads" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">loads</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">loads</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>JSON-load a string into a dict.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>s</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>JSON string.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Parsed dictionary.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/p2p_copy/protocol.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">loads</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    JSON-load a string into a dict.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s : str</span>
<span class="sd">        JSON string.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Dict[str, Any]</span>
<span class="sd">        Parsed dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="p2p_copy.protocol.file_begin" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">file_begin</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">file_begin</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">append_from</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Create a file begin control message.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Relative path.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Total file size.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>compression</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Compression type. Default is 'none'.</p>
              </div>
            </td>
            <td>
                  <code>&#39;none&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>append_from</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Byte offset to append from. Default is 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>JSON string of the message.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/p2p_copy/protocol.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">file_begin</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">compression</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">append_from</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a file begin control message.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        Relative path.</span>
<span class="sd">    size : int</span>
<span class="sd">        Total file size.</span>
<span class="sd">    compression : str, optional</span>
<span class="sd">        Compression type. Default is &#39;none&#39;.</span>
<span class="sd">    append_from : int, optional</span>
<span class="sd">        Byte offset to append from. Default is 0.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        JSON string of the message.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start of a file stream. If append_from is given, it indicates the sender will</span>
<span class="sd">    only send bytes from [append_from .. size) and the receiver should open in &#39;ab&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">msg</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;file&quot;</span><span class="p">,</span>
        <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span>
        <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="p">),</span>
        <span class="s2">&quot;compression&quot;</span><span class="p">:</span> <span class="n">compression</span><span class="p">,</span>
        <span class="s2">&quot;append_from&quot;</span><span class="p">:</span> <span class="n">append_from</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">dumps</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="p2p_copy.protocol.encrypted_file_begin" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">encrypted_file_begin</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">encrypted_file_begin</span><span class="p">(</span><span class="n">hidden_file_info</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Wrap encrypted file info in a control message.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>hidden_file_info</code>
            </td>
            <td>
                  <code><span title="bytes">bytes</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Encrypted file begin data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>JSON string of the enc_file message.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/p2p_copy/protocol.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">encrypted_file_begin</span><span class="p">(</span><span class="n">hidden_file_info</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrap encrypted file info in a control message.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hidden_file_info : bytes</span>
<span class="sd">        Encrypted file begin data.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        JSON string of the enc_file message.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;enc_file&quot;</span><span class="p">,</span>
        <span class="s2">&quot;hidden_file&quot;</span><span class="p">:</span> <span class="n">hidden_file_info</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="p2p_copy.protocol.pack_chunk" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">pack_chunk</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">pack_chunk</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Pack a chunk into a binary frame.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>seq</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sequence number.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>chain</code>
            </td>
            <td>
                  <code><span title="bytes">bytes</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>32-byte chain checksum.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>payload</code>
            </td>
            <td>
                  <code><span title="bytes">bytes</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The data payload.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="bytes">bytes</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Packed frame.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/p2p_copy/protocol.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">pack_chunk</span><span class="p">(</span><span class="n">seq</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">chain</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pack a chunk into a binary frame.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    seq : int</span>
<span class="sd">        Sequence number.</span>
<span class="sd">    chain : bytes</span>
<span class="sd">        32-byte chain checksum.</span>
<span class="sd">    payload : bytes</span>
<span class="sd">        The data payload.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bytes</span>
<span class="sd">        Packed frame.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">CHUNK_HEADER</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">chain</span><span class="p">)</span> <span class="o">+</span> <span class="n">payload</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="p2p_copy.protocol.unpack_chunk" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">unpack_chunk</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">unpack_chunk</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Unpack a binary chunk frame.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>frame</code>
            </td>
            <td>
                  <code><span title="bytes">bytes</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The binary frame.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="int">int</span>, <span title="bytes">bytes</span>, <span title="bytes">bytes</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>(seq, chain, payload)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If frame is too short.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/p2p_copy/protocol.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">unpack_chunk</span><span class="p">(</span><span class="n">frame</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Unpack a binary chunk frame.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    frame : bytes</span>
<span class="sd">        The binary frame.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Tuple[int, bytes, bytes]</span>
<span class="sd">        (seq, chain, payload)</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If frame is too short.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">CHUNK_HEADER</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;short chunk frame&quot;</span><span class="p">)</span>
    <span class="n">seq</span><span class="p">,</span> <span class="n">chain</span> <span class="o">=</span> <span class="n">CHUNK_HEADER</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">frame</span><span class="p">[:</span><span class="n">CHUNK_HEADER</span><span class="o">.</span><span class="n">size</span><span class="p">])</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">frame</span><span class="p">[</span><span class="n">CHUNK_HEADER</span><span class="o">.</span><span class="n">size</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">seq</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">payload</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p>&nbsp;</p>


<div class="doc doc-object doc-module">



<h2 id="p2p_copy.io_utils" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">p2p_copy.io_utils</span>


</h2>

    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="p2p_copy.io_utils.read_in_chunks" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">read_in_chunks</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">read_in_chunks</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="n">CHUNK_SIZE</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Asynchronously read bytes from a file in chunks.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>fp</code>
            </td>
            <td>
                  <code><span title="typing.BinaryIO">BinaryIO</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The file pointer to read from.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>chunk_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Size of each chunk in bytes. Default is 1 MiB.</p>
              </div>
            </td>
            <td>
                  <code><span title="p2p_copy.io_utils.CHUNK_SIZE">CHUNK_SIZE</span></code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Yields:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="bytes">bytes</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The next chunk of data.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/p2p_copy/io_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_in_chunks</span><span class="p">(</span><span class="n">fp</span><span class="p">:</span> <span class="n">BinaryIO</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">CHUNK_SIZE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterable</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Asynchronously read bytes from a file in chunks.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fp : BinaryIO</span>
<span class="sd">        The file pointer to read from.</span>
<span class="sd">    chunk_size : int, optional</span>
<span class="sd">        Size of each chunk in bytes. Default is 1 MiB.</span>

<span class="sd">    Yields</span>
<span class="sd">    ------</span>
<span class="sd">    bytes</span>
<span class="sd">        The next chunk of data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># Read from disk without blocking the event-loop</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">yield</span> <span class="n">chunk</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="p2p_copy.io_utils.compute_chain_up_to" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">compute_chain_up_to</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">compute_chain_up_to</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Compute chained checksum over the raw bytes of a file up to a limit.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>limit</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum bytes to hash. If None, hash the entire file.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="tuple">tuple</span>[<span title="int">int</span>, <span title="bytes">bytes</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>(bytes_hashed, final_chain_bytes)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/p2p_copy/io_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">compute_chain_up_to</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute chained checksum over the raw bytes of a file up to a limit.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : Path</span>
<span class="sd">        Path to the file.</span>
<span class="sd">    limit : int, optional</span>
<span class="sd">        Maximum bytes to hash. If None, hash the entire file.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple[int, bytes]</span>
<span class="sd">        (bytes_hashed, final_chain_bytes)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">c</span> <span class="o">=</span> <span class="n">ChainedChecksum</span><span class="p">()</span>
    <span class="n">hashed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">with</span> <span class="n">path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">,</span> <span class="n">CHUNK_SIZE</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">hashed</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                <span class="n">c</span><span class="o">.</span><span class="n">next_hash</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">remaining</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">remaining</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">to_read</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">remaining</span><span class="p">,</span> <span class="n">CHUNK_SIZE</span><span class="p">)</span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">,</span> <span class="n">to_read</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">hashed</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                <span class="n">remaining</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                <span class="n">c</span><span class="o">.</span><span class="n">next_hash</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hashed</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">prev_chain</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="p2p_copy.io_utils.iter_manifest_entries" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">iter_manifest_entries</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">iter_manifest_entries</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Yield manifest entries for files in the given paths (files or directories).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>paths</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of file or directory paths.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Yields:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="pathlib.Path">Path</span>, <span title="pathlib.Path">Path</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>(absolute_path, relative_path, size)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <ul>
<li>Yields files in sorted order for directories.</li>
<li>Skips non-existent or invalid paths.</li>
</ul>
</details>

            <details class="quote">
              <summary>Source code in <code>src/p2p_copy/io_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">iter_manifest_entries</span><span class="p">(</span><span class="n">paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yield manifest entries for files in the given paths (files or directories).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    paths : List[str]</span>
<span class="sd">        List of file or directory paths.</span>

<span class="sd">    Yields</span>
<span class="sd">    ------</span>
<span class="sd">    Tuple[Path, Path, int]</span>
<span class="sd">        (absolute_path, relative_path, size)</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Yields files in sorted order for directories.</span>
<span class="sd">    - Skips non-existent or invalid paths.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[p2p_copy] send(): files or dirs must be passed as list&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">paths</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">for</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[p2p_copy] send(): probably not a file:&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[p2p_copy] send(): file does not exist:&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">p</span><span class="o">.</span><span class="n">resolve</span><span class="p">(),</span> <span class="n">Path</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">p</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">root</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">sub</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                    <span class="n">rel</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">/</span> <span class="n">sub</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="n">sub</span><span class="o">.</span><span class="n">resolve</span><span class="p">(),</span> <span class="n">rel</span><span class="p">,</span> <span class="n">sub</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="p2p_copy.io_utils.ensure_dir" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">ensure_dir</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">ensure_dir</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Ensure the directory exists, creating parents if needed.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>p</code>
            </td>
            <td>
                  <code><span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to ensure is a directory.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/p2p_copy/io_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ensure_dir</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ensure the directory exists, creating parents if needed.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    p : Path</span>
<span class="sd">        The path to ensure is a directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p>&nbsp;</p>
<p>For api usage examples, see <a href="../examples/">APIExamples</a>. For feature details, see <a href="../features/">Features</a>.</p>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["content.tabs.link", "navigation.instant", "navigation.sections", "navigation.top", "search.suggest", "search.highlight"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>